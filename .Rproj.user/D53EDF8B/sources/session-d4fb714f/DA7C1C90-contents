library(shiny)

# Servidor
server <- function(input, output) {
  output$image_output <- renderImage({
    if (input$goButton == 0) {
      # Mostra a imagem inicial antes de qualquer classificação
      list(src = "www/human_or_not_human.png", height = "400", width = "400")
    } else {
      # Dependendo da previsão, mostrar a imagem correspondente
      prediction <- eventReactive(input$goButton, {
        user_data <- data.frame(
          hair_color = as.numeric(hair_color_map[input$hair_color]),
          skin_color = as.numeric(skin_color_map[input$skin_color]),
          imc = input$imc
        )
        
        names(user_data) <- c("hair_color", "skin_color", "imc")
        cat("Debug: Dados de entrada preparados\n", file = stderr())
        
        prediction <- rf_tuned$predict_proba(user_data)[,2]
        cat("Debug: Previsão calculada\n", file = stderr())
        
        if (prediction > 0.7) {
          "Humano"
        } else {
          "Alienígena"
        }
      })()
      
      if (prediction == "Humano") {
        list(src = "www/humano_img.png", height = "400", width = "400")
      } else {
        list(src = "www/alienigena_img.png", height = "400", width = "400")
      }
    }
  }, deleteFile = FALSE)
  
  output$prediction <- renderText({
    if (input$goButton > 0) {  # Só mostrar a previsão após o botão ser pressionado
      eventReactive(input$goButton, {
        cat("Debug: Classificação iniciada\n", file = stderr())
        if (rf_tuned$predict_proba(data.frame(
          hair_color = as.numeric(hair_color_map[input$hair_color]),
          skin_color = as.numeric(skin_color_map[input$skin_color]),
          imc = input$imc
        ))[,2] > 0.7) {
          "Humano"
        } else {
          "Alienígena"
        }
      })()
    }
  })
}
